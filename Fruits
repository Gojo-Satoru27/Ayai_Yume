--[[ 
    LƯU Ý:
    • Script này chờ 15 giây sau khi chạy để bạn có thời gian chọn phe (nếu server hiện thị menu chọn phe).
      Nếu bạn đã chọn phe, GUI tự tạo sẽ xuất hiện sau thời gian chờ.
    • Nếu bạn không chọn phe, mặc định game sẽ tự chọn (thường là Hải Quân) và script sẽ chạy sau thời gian chờ.
    • Điều chỉnh thời gian chờ bằng cách thay đổi giá trị của waitTime bên dưới.
    • Sử dụng script có thể vi phạm chính sách của Roblox. Hãy cân nhắc trước khi sử dụng.
--]]

_G.AutoCollectFruits = true   -- Bật/tắt Auto nhặt trái
_G.AutoServerHop = true       -- Bật/tắt Auto đổi server nếu không có trái

local waitTime = 15  -- Thời gian chờ (giây) cho phe chọn, bạn có thể điều chỉnh

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local fruitsCollected = 0
local startTime = os.time()

-- Chờ cho đến khi nhân vật load xong (và cho bạn thời gian chọn phe)
repeat wait() until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
print("Nhân vật đã load. Đợi " .. waitTime .. " giây cho việc chọn phe...")
wait(waitTime)

---------------------------------------------------
-- TẠO GUI MENU (như ảnh mẫu)
---------------------------------------------------
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AutoFruitMenu"
screenGui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 280, 0, 120)
mainFrame.Position = UDim2.new(0.5, -140, 0.1, 0)
mainFrame.BackgroundTransparency = 0.4
mainFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
mainFrame.Parent = screenGui

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, 0, 0.2, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.TextColor3 = Color3.new(1, 1, 1)
titleLabel.Font = Enum.Font.SourceSansBold
titleLabel.TextScaled = true
titleLabel.Text = "Auto Fruit - Blox Fruits"
titleLabel.Parent = mainFrame

local timeLabel = Instance.new("TextLabel")
timeLabel.Size = UDim2.new(1, 0, 0.2, 0)
timeLabel.Position = UDim2.new(0, 0, 0.2, 0)
timeLabel.BackgroundTransparency = 1
timeLabel.TextColor3 = Color3.new(1, 1, 1)
timeLabel.Font = Enum.Font.SourceSans
timeLabel.TextScaled = true
timeLabel.Text = "Time: 0s"
timeLabel.Parent = mainFrame

local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, 0, 0.2, 0)
statusLabel.Position = UDim2.new(0, 0, 0.4, 0)
statusLabel.BackgroundTransparency = 1
statusLabel.TextColor3 = Color3.new(1, 1, 1)
statusLabel.Font = Enum.Font.SourceSans
statusLabel.TextScaled = true
statusLabel.Text = "Tìm trái..."
statusLabel.Parent = mainFrame

local discordButton = Instance.new("TextButton")
discordButton.Size = UDim2.new(1, 0, 0.2, 0)
discordButton.Position = UDim2.new(0, 0, 0.6, 0)
discordButton.BackgroundTransparency = 0.2
discordButton.BackgroundColor3 = Color3.fromRGB(30, 144, 255)
discordButton.TextColor3 = Color3.new(1, 1, 1)
discordButton.Font = Enum.Font.SourceSansBold
discordButton.TextScaled = true
discordButton.Text = "Join Discord"
discordButton.Parent = mainFrame
discordButton.MouseButton1Click:Connect(function()
    setclipboard("https://discord.gg/3Tp35BhYeG")
    statusLabel.Text = "Link Discord đã sao chép!"
end)

-- Cập nhật thời gian chạy trên GUI
spawn(function()
    while _G.AutoCollectFruits do
        local elapsed = os.time() - startTime
        timeLabel.Text = "Time: " .. elapsed .. "s"
        wait(1)
    end
end)

---------------------------------------------------
-- HÀM THÔNG BÁO (có thể hiển thị qua output hoặc StarterGui)
---------------------------------------------------
local function Notify(msg)
    game.StarterGui:SetCore("SendNotification", {
        Title = "Auto Fruit Collector",
        Text = msg,
        Duration = 3
    })
end

---------------------------------------------------
-- TÌM TRÁI ÁC QUỶ GẦN NHẤT
---------------------------------------------------
local function FindNearestFruit()
    local nearestFruit, nearestDistance = nil, math.huge
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end
    for _, fruit in pairs(game.Workspace:GetChildren()) do
        if fruit:IsA("Model") and fruit:FindFirstChild("Handle") and string.find(fruit.Name, "Fruit") then
            local distance = (hrp.Position - fruit.Handle.Position).Magnitude
            if distance < nearestDistance then
                nearestFruit, nearestDistance = fruit, distance
            end
        end
    end
    return nearestFruit
end

---------------------------------------------------
-- TELEPORT SIÊU NHANH (sử dụng Tween để di chuyển nhanh mà ít bị kick)
---------------------------------------------------
local function TeleportToFruit(fruit)
    if not fruit or not fruit:FindFirstChild("Handle") then return end
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local targetPos = fruit.Handle.Position
    local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Linear)
    local tween = TweenService:Create(hrp, tweenInfo, {CFrame = CFrame.new(targetPos)})
    tween:Play()
    tween.Completed:Wait()
    
    wait(0.2)  -- chờ ổn định
    local prompt = fruit.Handle:FindFirstChildWhichIsA("ProximityPrompt")
    if prompt then
        fireproximityprompt(prompt)
        statusLabel.Text = "Nhặt thành công: " .. fruit.Name
    else
        statusLabel.Text = "Không tìm thấy prompt trên trái!"
    end
end

---------------------------------------------------
-- LƯU TRÁI VÀO KHO
---------------------------------------------------
local function StoreFruit()
    local fruitTool = player.Backpack:FindFirstChildWhichIsA("Tool")
    if fruitTool then
        local args = {"StoreFruit", fruitTool}
        ReplicatedStorage.Remotes.CommF_:InvokeServer(unpack(args))
        statusLabel.Text = "Đã lưu vào kho: " .. fruitTool.Name
    end
end

---------------------------------------------------
-- ĐỔI SERVER NẾU KHÔNG CÓ TRÁI
---------------------------------------------------
local function ServerHop()
    local url = "https://games.roblox.com/v1/games/2753915549/servers/Public?sortOrder=Asc&limit=100"
    local servers = HttpService:JSONDecode(game:HttpGet(url)).data
    for _, server in pairs(servers) do
        if server.playing < server.maxPlayers and server.id ~= game.JobId then
            statusLabel.Text = "Đang đổi server..."
            TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id, player)
            break
        end
    end
end

---------------------------------------------------
-- VÒNG LẶP AUTO NHẶT TRÁI
---------------------------------------------------
while _G.AutoCollectFruits do
    local fruit = FindNearestFruit()
    if fruit then
        TeleportToFruit(fruit)
        fruitsCollected = fruitsCollected + 1
        StoreFruit()
    else
        statusLabel.Text = "Không tìm thấy trái!"
        if _G.AutoServerHop then
            ServerHop()
        end
    end
    wait(5)  -- Kiểm tra lại mỗi 5 giây
end
